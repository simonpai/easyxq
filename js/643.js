!function(){"use strict";var t={d:function(e,r){for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r:function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{END:function(){return A},MOVE:function(){return v},RESUME:function(){return b},START:function(){return w},UNDO:function(){return k}});var r={};t.r(r),t.d(r,{AGREE_DRAW:function(){return $},MOVE:function(){return E},OFFER_DRAW:function(){return P},REQUEST_TAKEBACK:function(){return x},RESIGN:function(){return C}});var n={};t.r(n),t.d(n,{ACTION:function(){return r},EVENT:function(){return e}});var o={};t.r(o),t.d(o,{anyCheckToPreviousPlayersKing:function(){return lr},calls:function(){return ar},hasLegalPly:function(){return sr},isInCheck:function(){return cr},nextLegalPlies:function(){return ir},nextPlies:function(){return or},result:function(){return ur}});var i={};t.r(i),t.d(i,{filter:function(){return zr},scale:function(){return jr},softbans:function(){return Mr}});var s={};t.r(s),t.d(s,{naive:function(){return Kr},standard:function(){return Dr}});const c=11,a=12,u=13,l=15,h=1,f=2,d=3,p="base",m="violation",y="result",g="decisive",w="start",b="resume",v="move",k="undo",A="end",E="move",x="request-takeback",P="offer-draw",$="agree-draw",C="resign",O={[h]:h,[f]:f,r:h,w:h,b:f,red:h,white:h,black:f};function N(t){return function(t){if(void 0===t)throw new Error("Color is required.");if(t<1||t>2)throw new Error(`Invalid color code: ${t}.`);return t}(t)===h?"red":"black"}function S(t){return t===h?f:t===f?h:t===d?d:(()=>{throw new Error(`Invalid color code: ${t}`)})()}const j=8,z=7,M="AEHRCK-Paehrck-p",T=[{offset:0,limit:2},{offset:2,limit:2},{offset:4,limit:2},{offset:6,limit:2},{offset:8,limit:2},{offset:10,limit:1},{},{offset:11,limit:5},{offset:16,limit:2},{offset:18,limit:2},{offset:20,limit:2},{offset:22,limit:2},{offset:24,limit:2},{offset:26,limit:1},{},{offset:27,limit:5}],I=Object.freeze({["A".charCodeAt()]:0,["a".charCodeAt()]:8,["E".charCodeAt()]:1,["e".charCodeAt()]:9,["H".charCodeAt()]:2,["h".charCodeAt()]:10,["R".charCodeAt()]:3,["r".charCodeAt()]:c,["C".charCodeAt()]:4,["c".charCodeAt()]:a,["K".charCodeAt()]:5,["k".charCodeAt()]:u,["P".charCodeAt()]:7,["p".charCodeAt()]:l,["B".charCodeAt()]:1,["b".charCodeAt()]:9,["N".charCodeAt()]:2,["n".charCodeAt()]:10});function L(t){return t<0?t:t&z}function R(t){const e=I[t];if(void 0===e)throw new Error(`Unrecognized code point: ${t}`);return e}Object.freeze([0,1,2,3,4,5,7,8,9,10,c,a,u,l]);const K=["advisor","elephant","horse","rook","cannon","king","","pawn"],U=["仕","相","傌","俥","炮","帥","","兵","士","象","馬","車","包","將","","卒"];function B(t){return`${N(function(t){return t<j?h:f}(t))} ${K[L(t)]}`}function q(t){return U[t]}const D=-1;function _(t){return t<0}function H(t){return t>=0}function V(t){return t>=0&&t<16}function W(t){return 1+(t>>4)}function F(t){return _(t)?D:16^t}function G(t){return(function(t){return 16|t}(t)>26?15|t:t)>>1}function Q(t){return e=G(t),M.charAt(e);var e}function J(t){return 10===t}function X(t){return J(t)||function(t){return 26===t}(t)}function Y(t){return t>>1==8}function Z(t){return t>>1==10}function tt(t){return t>>1==4}const et=255,rt=153,nt=16,ot=-16,it=1,st=-1,ct=nt+st,at=nt+it,ut=ot+st,lt=ot+it,ht=(nt<<1)+st,ft=(nt<<1)+it,dt=(ot<<1)+st,pt=(ot<<1)+it,mt=(st<<1)+nt,yt=(st<<1)+ot,gt=(it<<1)+nt,wt=(it<<1)+ot,bt=ct<<1,vt=at<<1,kt=ut<<1,At=lt<<1;function Et(t){return t>>4}function xt(t){return 15&t}function Pt(t){return t===et}function $t(t){return t>=0&&(15&t)<9&&t>>4<10}Object.freeze({*[Symbol.iterator](){for(let t=0;t<10;t++)for(let e=t<<4,r=e+9;e<r;e++)yield e}});const Ct=rt-1;function Ot(t){return Ct-t}function*Nt(t,e){for(t+=e;$t(t);)yield t,t+=e}function St(t){return(15&t)<8?t+1:t<Ct?16+(240&t):-1}const jt=Object.freeze(new Set([3,4,5,19,20,21,35,36,37])),zt=(Object.freeze({RED:jt,BLACK:Object.freeze(new Set([...jt].map(Ot)))}),Object.freeze(new Set([2,6,32,36,40,66,70]))),Mt=Object.freeze({RED:zt,BLACK:Object.freeze(new Set([...zt].map(Ot)))}),Tt=Object.freeze(new Set([3,5,35,37])),It=Object.freeze({RED:Tt,BLACK:Object.freeze(new Set([...Tt].map(Ot)))});function Lt(t){return t===et?"--":String.fromCharCode(97+(15&t))+""+(t>>4)}const Rt=["一","二","三","四","五","六","七","八","九"],Kt=["１","２","３","４","５","６","７","８","９"],Ut="進",Bt="退",qt="平",Dt="前",_t="中",Ht="後";function Vt(t,e){return(t===h?Rt:Kt)[8-e]}function Wt(t,e){return t.sort(((t,r)=>e(t)-e(r))),t}const Ft="undefined"!=typeof window,Gt="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope,Qt=Ft||Gt,Jt=Qt?self.btoa:t=>Buffer.from(t,"binary").toString("base64"),Xt=Qt?self.atob:t=>Buffer.from(t,"base64").toString("binary");function Yt(t,e){for(const r in e)e.hasOwnProperty(r)&&Object.defineProperty(t,r,{value:e[r]})}class Zt extends Error{constructor(t,e){super(t),this.name="InvalidPlyError",this.data=e}}function te(t,e,r,n=t.color){!function(t,e){if(!$t(t))throw new Zt(`Origin square index is out of bound: ${t}`);if(!$t(e))throw new Zt(`Destination square index is out of bound: ${e}`);if(t===e)throw new Zt(`Origin and destination cannot be the same: ${Lt(t)}`)}(e,r),function(t,e,r,n){const{board:o}=t;if(W(o.at(e))!==n)throw new Zt(`No ${N(n)} piece at ${Lt(e)}`);if(W(o.at(r))===n)throw new Zt(`A ${N(n)} piece occupies destination square: ${Lt(r)}`)}(t,e,r,n),function(t,e,r,n){let{board:o}=t,i=o.at(e);n===f&&(o=o.mirror,i=F(i),e=Ot(e),r=Ot(r)),ee[G(i)](e,r,o)}(t,e,r,n)}const ee=[function(t,e){if(!(20===t&&re(e)||20===e&&re(t)))throw new Zt("Illegal movement for advisor.")},function(t,e,r){const n=Math.abs(t-e);if(34!==n&&30!==n)throw new Zt("Illegal movement for elephant.");ne(r,t+e>>1,"Elephant")},function(t,e,r){let n;switch(e-t){case 33:case 31:n=16;break;case-33:case-31:n=-16;break;case 18:case-14:n=1;break;case-18:case 14:n=-1;break;default:throw new Zt("Illegal movement for horse.")}ne(r,t+n,"Horse")},function(t,e,r){const n=oe(t,e,"rook");for(let o=t+n;o!==e;o+=n)ne(r,o,"Rook")},function(t,e,r){const n=oe(t,e,"cannon"),o=_(r.at(e))?0:1;let i=0;for(let s=t+n;s!==e&&(_(r.at(s))||(i++,!(i>o)));s+=n);if(i!==o)throw new Zt("Illegal movement for cannon.")},function(t,e){const r=15&e;if(r<3||r>5||e>>4>2)throw new Zt("Illegal destination for king.");const n=Math.abs(e-t);if(1!==n&&16!==n)throw new Zt("Illegal movement for king.")},void 0,function(t,e){const r=e-t;if(!(16===r||(1===r||-1===r)&&t>>4>4))throw new Zt("Illegal movement for pawn.")}];function re(t){const e=t>>4,r=15&t;return!(0!==e&&2!==e||3!==r&&5!==r)}function ne(t,e,r){if(!_(t.at(e)))throw new Zt(`${r} movement is blocked.`)}function oe(t,e,r){const n=t>>4,o=15&t,i=e>>4,s=15&e;if(n!==i&&o!==s)throw new Zt(`Illegal movement for ${r}.`);return n===i?o<s?1:-1:n<i?16:-16}class ie{#t;static decode(t){let e=t>>22&63;return e=63===e?-1:e,new ie(t>>6&255,t>>14&255,63&t,e)}constructor(t,e,r,n){const o=function(t,e,r,n){return r|t<<6|e<<14|(n<0?63:n)<<22}(t,e,r,n);Yt(this,{from:t,to:e,pid:r,captured:n,code:o})}get color(){return W(this.pid)}get mirror(){return new ie(Ot(this.from),Ot(this.to),F(this.pid),F(this.captured))}get hash(){return void 0===this.#t&&(this.#t=function({pid:t,from:e,captured:r,to:n}){const o=De(t,e)^De(t,n);return H(r)?o^De(r,n):o}(this)),this.#t}get snapshot(){const{from:t,to:e,pid:r,captured:n,color:o}=this;return{from:t,to:e,pid:r,captured:n,color:o}}toString(){return`${Q(this.pid)}/${Lt(this.from)}${Lt(this.to)}`+(H(this.captured)?`/${Q(this.captured)}`:"")}}class se{constructor(t,e){this.sid=t,this.pid=e,Object.freeze(this)}get mirror(){return new se(Ot(this.sid),F(this.pid))}toString(){return`${Q(this.pid)}/${Lt(this.sid)}`}}const ce=[ge,ge,be,be,ve,ve,Ae,Ae,xe,xe,function*(t){const e=t>>4;e>0&&(yield t+ot),e<2&&(yield t+nt);const r=15&t;r>3&&(yield t+st),r<5&&(yield t+it)},$e,$e,$e,$e,$e];function*ae({board:t},e){_(e)||(yield*(V(e)?le:ue)(t,e))}function*ue(t,e){for(const r of le(t.mirror,F(e)))yield r.mirror}function*le(t,e){const r=t.pieces.get(e);for(const n of ce[e](r,t)){const e=t.at(n);V(e)&&!J(e)&&(yield new se(n,e))}}function*he({board:t,color:e}){yield*(e===h?de:ye)(t)}function*fe({board:t},e){if(_(e))return;const r=t.pieces.get(e);yield*(V(e)?me:pe)(t,e,r)}function*de(t){for(const{pid:e,sid:r}of t.pieces.RED)yield*me(t,e,r)}function*pe(t,e,r){for(const n of me(t.mirror,F(e),Ot(r)))yield n.mirror}function*me(t,e,r){for(const n of ce[e](r,t)){const o=t.at(n);V(o)||(yield new ie(r,n,e,o))}}function*ye(t){for(const e of de(t.mirror))yield e.mirror}function*ge(t){20===t?(yield 3,yield 5,yield 35,yield 37):yield 20}const we=[32,2,66,36,6,70,40].reduce(((t,e)=>{const r=e>>4,n=15&e,o=[];function i(t){const r=e+t;o.push([r,r+t])}return n>0&&(r>0&&i(ut),r<4&&i(ct)),n<8&&(r>0&&i(lt),r<4&&i(at)),t.set(e,o),t}),new Map);function*be(t,e){for(const[r,n]of we.get(t))Ce(e,r)&&(yield n)}function*ve(t,e){const r=t>>4,n=15&t;n>1&&Ce(e,t+st)&&(r>0&&(yield t+yt),r<9&&(yield t+mt)),n<7&&Ce(e,t+it)&&(r>0&&(yield t+wt),r<9&&(yield t+gt)),r>1&&Ce(e,t+ot)&&(n>0&&(yield t+dt),n<8&&(yield t+pt)),r<8&&Ce(e,t+nt)&&(n>0&&(yield t+ht),n<8&&(yield t+ft))}const ke=[nt,ot,st,it];function*Ae(t,e){for(const r of ke)yield*Ee(t,e,r)}function*Ee(t,e,r){for(const n of Nt(t,r))if(yield n,!Ce(e,n))return}function*xe(t,e){for(const r of ke)yield*Pe(t,e,r)}function*Pe(t,e,r){let n=!1;for(const o of Nt(t,r)){const t=Ce(e,o);if(n){if(!t)return void(yield o)}else t?yield o:n=!0}}function*$e(t){const e=t>>4;if(e<5)yield t+nt;else{e<9&&(yield t+nt);const r=15&t;r>0&&(yield t+st),r<8&&(yield t+it)}}function Ce(t,e){return _(t.at(e))}function Oe(){return Math.random()*2**32|0}function Ne(t){return t[Math.floor(Math.random()*t.length)]}function Se(t){for(const e of t)return e}function je(t){return Se(function*(t){var e;yield*Ie(t,(e=t.color,1===e?10:26))}(t))}function*ze(t,e){for(const r of fe(t,e))H(r.captured)&&(yield r)}function Me(t,e,r){const{pieces:n}=t.board;return function(t,e,r,n){try{return te(t,e,r,n),!0}catch(t){return!1}}(t,n.get(r),n.get(e),W(r))}function Te(t,e){return Se(Ie(t,e))}function*Ie(t,e){const r=S(W(e)),n=t.board.pieces.get(e),o=X(e);yield*function*({board:t},{color:e,sid:r,toKing:n=!1}={}){const o=e===h?Le:Re;for(const e of o(t,r,n))yield t.ply(e,r)}(t,{color:r,sid:n,toKing:o})}function*Le(t,e,r){for(const n of Re(t.mirror,Ot(e),r))yield Ot(n)}function*Re(t,e,r){for(const n of[nt,st,it,ot])yield*Ke(t,e,n,r);yield*function*(t,e){for(const[r,...n]of Ue)if(_(t.at(e+r)))for(const r of n){const n=e+r;$t(n)&&(Z(t.at(n))&&(yield n))}}(t,e),r||(yield*function*(t,e){if(Mt.BLACK.has(e))for(const[r,n]of Be){if(!_(t.at(e+r)))continue;const o=e+n;$t(o)&&(t.at(o)>>1==9&&(yield o))}}(t,e)),r||(yield*function*(t,e){if(132===e){let e=0;for(const r of It.BLACK)if(Y(t.at(r))&&(yield r,2==++e))break}It.BLACK.has(e)&&Y(t.at(132))&&(yield 132)}(t,e))}function*Ke(t,e,r,n=!1){let o=!1,i=!0;for(const s of Nt(e,r)){const e=t.at(s);if(_(e)){i=!1;continue}const h=G(e);if(o)return void(h===a&&(yield s));switch(h){case c:yield s;break;case u:(n||i)&&(yield s);break;case l:i&&r!==ot&&(r===nt||s>>4<5)&&(yield s)}i=!1,o=!0}}const Ue=[[ct,ht,mt],[at,ft,gt],[ut,dt,yt],[lt,pt,wt]],Be=[[ct,bt],[at,vt],[ut,kt],[lt,At]],qe=new Map;function De(t,e){return function(t){if(qe.has(t))return qe.get(t);const e=Oe();return qe.set(t,e),e}((e<<4)+G(t))}function _e({board:t,color:e}){const r=t.hash^function(t){return t-1}(e);return r&r}function He(t){return Int8Array.from(t)}function Ve(t){const e=[];for(let r=9;r>=0;r--){let n="",o=0,i=r<<4;function s(){o&&(n+=`${o}`,o=0)}for(let c=0;c<9;c++){const a=t.at(i);_(a)?o++:(s(),n+=Q(a)),i++}s(),e.push(n)}return e.join("/")}function We(){const t=new Int8Array(rt);return t.fill(D),t}let Fe;class Ge{#e;#r;#t;constructor(t){this.#e=t,this.#t=this.#e.hash^(Fe||(Fe=Oe())),Yt(this,{mirrored:!0})}get notation(){return this.#r||(this.#r=this.#n())}get hash(){return this.#t}get pieces(){return this.#e.pieces.mirror}get mirror(){return this.#e}at(t){return F(this.#e.at(Ot(t)))}ply(t,e){return this.#e.ply(Ot(t),Ot(e)).mirror}#n(){const t=this.#e.notation,e=t.length,r=Array(e);for(let n=0;n<e;n++){const o=t.charCodeAt(e-1-n);r[n]=o>64?32^o:o}return String.fromCharCode(...r)}}class Qe{#o;constructor(t){this.#o=t}get(t){return Ot(this.#o.get(F(t)))}*slice(t,e){if(!(t>=e))if(0===t&&32===e||t>=16||e<16)for(const t of this.#o.slice(0,32))yield t.mirror;else if(t>=16||e<16)for(const r of this.#o.slice(F(t),F(e)))yield r.mirror;else{for(const t of this.#o.slice(0,F(e)))yield t.mirror;for(const e of this.#o.slice(F(t),32))yield e.mirror}}transit(t){return this.#o.transit(t.mirror).mirror}}class Je{#o;#i;#s;constructor(t,e){this.#o=t,this.#i=e}get(t){const{to:e,pid:r,captured:n}=this.#i;return t===r?e:t===n?et:this.#o.get(t)}*slice(t,e){const{to:r,pid:n,captured:o}=this.#i;for(const i of this.#o.slice(t,e))i.pid===n?yield new se(r,n):i.pid!==o&&(yield i)}get mirror(){return this.#s||(this.#s=new Qe(this))}preview(t){return new Je(this,t)}}function Xe(t,e,r){t.fill(r,e,e+1)}class Ye{static fromBoard(t){const e=new Uint8Array(32);e.fill(et);for(let r=0;r>=0;r=St(r)){const n=t.at(r);_(n)||Xe(e,n,r)}return new Ye(e)}static load(t){return new Ye(new Uint8Array(function(t){const e=Xt(t),r=e.length,n=new Uint8Array(r);for(let t=0;t<r;t++)n.fill(e.charCodeAt(t),t,t+1);return n.buffer}(t)))}#c;#a;#s;constructor(t){this.#c=t}get(t){return this.#c.at(t)}*slice(t,e){for(let r=t;r<e;r++){const t=this.#c.at(r);t!==et&&(yield new se(t,r))}}get mirror(){return this.#s||(this.#s=new Qe(this))}get snapshot(){return this.#a||(this.#a=function(t){let e="";for(const r of new Uint8Array(t))e+=String.fromCharCode(r);return Jt(e)}(this.#c.buffer))}preview(t){return new Je(this,t)}transit(t){const e=new Uint8Array(this.#c),{to:r,pid:n,captured:o}=t;return Xe(e,n,r),H(o)&&Xe(e,o,et),new Ye(e)}undo(t){const e=new Uint8Array(this.#c),{from:r,to:n,pid:o,captured:i}=t;return Xe(e,o,r),H(i)&&Xe(e,i,n),new Ye(e)}}class Ze{static fromBoard(t){return new Ze(Ye.fromBoard(t))}static load(t){return new Ze(Ye.load(t))}#o;#s;constructor(t){this.#o=t}*[Symbol.iterator](){yield*this.#o.slice(0,32)}get(t){return this.#o.get(t)}get RED(){return this.#o.slice(0,16)}get BLACK(){return this.#o.slice(16,32)}get RED_PAWNS(){return this.#o.slice(11,16)}get BLACK_PAWNS(){return this.#o.slice(27,32)}ofColor(t){return t===h?this.RED:this.BLACK}get mirror(){return this.#s||(this.#s=new Ze(this.#o.mirror))}get snapshot(){return this.#o.snapshot}preview(t){return new Ze(this.#o.preview(t))}transit(t){return new Ze(this.#o.transit(t))}undo(t){return new Ze(this.#o.undo(t))}}class tr{#u;#i;#r;#l;#s;constructor(t,e){e.pid||(e=t.ply(e.from,e.to)),this.#u=t,this.#i=e}get isPreview(){return!0}get notation(){return this.#r||(this.#r=Ve(this))}get hash(){return this.#u.hash^this.#i.hash}get pieces(){return this.#l||(this.#l=this.#u.pieces.preview(this.#i))}get mirror(){return this.#s||(this.#s=new Ge(this))}at(t){const{from:e,to:r,pid:n}=this.#i;return t===e?-1:t===r?n:this.#u.at(t)}commit(){return this.#u.transit(this.#i)}ply(t,e){return new ie(t,e,this.at(t),this.at(e))}preview(t){return new tr(this,t)}}class er{static parse(t){return new er(function(t){const e=We();function r(e){throw new Error(`Unrecognized character "${t.charAt(e)}" in FEN at index ${e}.`)}function n(t){throw new Error(`Invalid FEN: incorrect number of cells in rank ${t+1}.`)}function o(){throw new Error("Invalid FEN: incorrect number of ranks.")}const i=function(){const t=Array(16).fill(0);return Object.freeze({get(e){const{offset:r,limit:n}=T[e],o=t[e]++;if(o>=n)throw new Error(`Exceed piece limit (${n}) for ${B(e)}`);return r+o}})}();let s=9,c=0;for(let a=0,u=s<<4,l=t.length;a<l;a++){const l=t.charCodeAt(a);if(l>64){(l>122||l>90&&l<97)&&r(a),c++,c>9&&n(s);const t=u+1;e.fill(i.get(R(l)),u,t),u=t}else if(l>48&&l<58){l>57&&r(a);const t=15&l;c+=t,c>9&&n(s),u+=t}else 47===l&&(9!==c&&n(s),s--,c=0,u=s<<4,s<0&&o())}return 0!==s&&o(),9!==c&&n(s),e}(t))}static load(t){const e=Ze.load(t),r=function(t){const e=We();for(const{sid:r,pid:n}of t)e.fill(n,r,r+1);return e}(e);return new er(r,{pieces:e})}#c;#r;#l;#s;#t;#h;constructor(t,e={}){this.#c=t,this.#h=e}get notation(){return this.#r||(this.#r=Ve(this.#c))}get hash(){if(void 0===this.#t){const{parent:t,hash:e,ply:r}=this.#h;this.#t=void 0!==e?e:void 0!==t&&r?t^r.hash:function(t){let e=0;for(const{pid:r,sid:n}of t.pieces)e^=De(r,n);return e}(this)}return this.#t}get pieces(){return this.#l||(this.#l=this.#h.pieces||Ze.fromBoard(this))}get mirror(){return this.#s||(this.#s=new Ge(this))}get snapshot(){return this.pieces.snapshot}at(t){return this.#c.at(t)}ply(t,e){return new ie(t,e,this.at(t),this.at(e))}preview(t){return new tr(this,t)}transit(t){t.pid||(t=this.ply(t.from,t.to));const{from:e,to:r}=t,n=He(this.#c);return n.fill(this.#c.at(e),r,r+1),n.fill(-1,e,e+1),new er(n,{parent:this.hash,ply:t,pieces:this.pieces.transit(t)})}undo(t){const{from:e,to:r,pid:n,captured:o}=t,i=He(this.#c);return i.fill(n,e,e+1),i.fill(o,r,r+1),new er(i,{hash:this.hash^t.hash,pieces:this.pieces.undo(t)})}}class rr{#f;#i;#d;#t;constructor(t,e){this.#f=t,this.#i=e}get board(){return this.#d||(this.#d=this.#f.board.preview(this.#i))}get color(){return S(this.#f.color)}get clock(){return _(this.#i.captured)?0:this.#f.clock+1}get moveNum(){return this.#f.color===f?this.#f.moveNum+1:this.#f.moveNum}get isPreview(){return!0}get fen(){return Reflect.get(this.#f,"fen",this)}get hash(){return this.#t||(this.#t=_e(this))}ply(t,e){return this.board.ply(t,e)}preview(t){return new rr(this,t)}}class nr{static#p;static standard(){return nr.#p||(nr.#p=nr.parse("rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR r - - 0 1"))}static parse(t){const[e,r="r",n,o,i="0",s="1"]=t.split(/\s+/g);return new nr({board:er.parse(e),color:(c=r,O[c&&c.toLowerCase()]||(()=>{throw new Error(`Unrecognized color notation: ${c}.`)})()),clock:Number(i),moveNum:Number(s)});var c}static load({board:t,color:e,clock:r,moveNum:n}){return new nr({board:er.load(t),color:e,clock:r,moveNum:n})}#m;#t;#y;constructor({board:t,color:e,clock:r=0,moveNum:n=1}){Yt(this,{board:t,color:e,clock:r,moveNum:n})}get fen(){return this.#m||(this.#m=`${this.board.notation} ${function(t){switch(t){case h:return"r";case f:return"b"}throw new Error(`Unrecognized color code: ${t}.`)}(this.color)} - - ${this.clock} ${this.moveNum}`)}get hash(){return this.#t||(this.#t=_e(this))}get snapshot(){return this.#y||(this.#y=Object.freeze({board:this.board.snapshot,color:this.color,clock:this.clock,moveNum:this.moveNum}))}ply(t,e){return this.board.ply(t,e)}preview(t){return new rr(this,t)}transit(t){t.piece||(t=this.ply(t.from,t.to));const e=S(this.color);return new nr({board:this.board.transit(t),color:e,clock:H(t.captured)?0:this.clock+1,moveNum:this.color===f?this.moveNum+1:this.moveNum})}undo(t,{clock:e=0}={}){const r=S(this.color);return new nr({board:this.board.undo(t),color:r,clock:H(t.captured)?e:this.clock-1,moveNum:r===f?this.moveNum-1:this.moveNum})}}function or(t,e){return[...he(e)].map((r=>{const n=e.preview(r);try{r.calls=[...t.apply("preTransit",{position:e,ply:r,preview:n})]}catch(t){r.calls=[hr(t)]}for(const t of r.calls)if(t.type===m){r.violation=t;break}return r}))}function ir(t,e){return or(t,e).filter((t=>!t.violation))}function sr(t,e){t:for(const r of he(e)){const n=e.preview(r);try{for(const o of t.apply("preTransit",{position:e,ply:r,preview:n}));}catch(t){if(t instanceof Zt)continue t;throw t}return!0}return!1}function cr(t,e){return!!je(e)}function ar(t,e){return[...t.apply("onPosition",{position:e})]}function ur(t,e){return function(t){for(const e of t)if(e.type===y){const{[y]:t,...r}=e;return{...r,type:t}}}(ar(t,e))}function lr(t,e){const{board:r,color:n,hash:o}=e;return je({board:r,color:S(n),hash:o})}function hr(t){if(t instanceof Zt)return{type:m,reason:t.message};throw t}const fr=Object.keys(o);class dr{#g;#w;#b;constructor(t,e){this.#w=t,this.#g=e,this.#b=fr.reduce(((t,e)=>(t[e]=void 0,t)),{})}get nextPlies(){return this.#b.nextPlies||(this.#b.nextPlies=or(this.#w,this.#g))}get nextLegalPlies(){return this.#b.nextLegalPlies||(this.#b.nextLegalPlies=ir(this.#w,this.#g))}get hasLegalPly(){return this.#b.hasLegalPly||(this.#b.hasLegalPly=sr(this.#w,this.#g))}get isInCheck(){return this.#b.isInCheck||(this.#b.isInCheck=cr(this.#w,this.#g))}get calls(){return this.#b.calls||(this.#b.calls=ar(this.#w,this.#g))}get result(){return this.#b.result||(this.#b.result=ur(this.#w,this.#g))}get anyCheckToPreviousPlayersKing(){return this.#b.anyCheckToPreviousPlayersKing||(this.#b.anyCheckToPreviousPlayersKing=lr(this.#w,this.#g))}}const pr=[class{static get name(){return p}#v;initialize(t){this.#v=t}*preMove({position:t,from:e,to:r}){te(t,e,r)}*preTransit({preview:t}){const e=this.#v.queries(t).anyCheckToPreviousPlayersKing;if(e)throw new Zt(`King in check by ${B(G(e.pid))} after the move.`,{check:e})}*onPosition({position:t}){const e=this.#v.queries(t);if(!e.hasLegalPly){const{isInCheck:r}=e;yield{type:y,result:g,winner:S(t.color),reason:r?"checkmate":"stalemate"}}}}],mr=pr.reduce(((t,e)=>(t[e.name]=e,t)),{});function yr(t){return"string"==typeof t&&(t=mr[t]),"function"==typeof t&&(t=new t),t}class gr{#w;constructor(t){this.#w=t.map(yr)}*[Symbol.iterator](){for(const t of this.#w)yield t}*apply(t,e){for(const r of this.#w)r[t]&&(yield*r[t](e))}}class wr{#w;constructor({rules:t=[p]}={}){this.#w=new gr(t);for(const t of this.#w)t.initialize(this)}get rules(){return this.#w}queries(t){return new dr(this.#w,t)}transit(t,e,r){const{rules:n}=this;let o=[...n.apply("preMove",{position:t,from:e,to:r})];const i=t.ply(e,r),s=function(t,e){const r=function(t,e){const r=G(e.pid),n=W(e.pid);let o=t.board;n===f&&(o=o.mirror,e=e.mirror);const{from:i,to:s}=e,c=xt(i);let a=0,u=0,l=!1;switch(L(r)){case 5:case 0:case 1:a=1;break;case 2:case 3:case 4:const t=1^e.pid,n=o.pieces.get(t);Pt(n)||xt(n)!==c?a=1:(a=2,Et(i)<Et(n)&&u++);break;case 7:const s=Et(i);let h=0;for(const{sid:t}of o.pieces.RED_PAWNS){if(Pt(t))continue;const e=xt(t),r=1<<e;e===c?(Et(t)>s&&u++,a++):h&r&&(l=!0),h|=r}break;default:throw new Error(`Unknown piece: ${r}`)}return{color:n,piece:r,from:i,to:s,file:c,stack:a,ordinal:u,disambiguation:l}}(t,e);return`${function(t){const{stack:e,color:r,piece:n,file:o}=t;return 1===e?`${q(n)}${Vt(r,o)}`:`${function({ordinal:t,stack:e}){if(0===t)return Dt;switch(e){case 1:throw new Error("Unexpected stack size: 1");case 2:return Ht;case 3:return 1===t?_t:Ht;default:return Rt[t]}}(t)}${function({color:t,piece:e,file:r,disambiguation:n}){return n?Vt(t,r):q(e)}(t)}`}(r)}${function({color:t,from:e,to:r}){const n=xt(e),o=Et(e),i=xt(r),s=Et(r);return`${s===o?qt:s>o?Ut:Bt}${n===i?function(t,e){return(t===h?Rt:Kt)[e-1]}(t,Math.abs(s-o)):Vt(t,i)}`}(r)}`}(t,i),c=t.preview(i);return o=[...o,...n.apply("preTransit",{position:t,ply:i,preview:c})],t=t.transit(i),o=[...o,...n.apply("postTransit",{position:t,ply:i})],[t,i,o,s]}}const{ACTION:br}=n,vr={move(t,{from:e,to:r}){this.send(br.MOVE,{index:t,from:e,to:r})},requestTakeback(t){this.send(br.REQUEST_TAKEBACK,{index:t})}};Object.assign(class{#k;constructor(t,e){this.#k=e,this.color=t,Object.freeze(this)}subscribe(t){return this.#k.subscribe(t)}send(t,e){this.#k.send(t,e)}}.prototype,vr);const{ACTION:kr,EVENT:Ar}=n;class Er{static load({initialPosition:t,position:e,plies:r,result:n}){return t=t?nr.load(t):nr.standard(),e=e?nr.load(e):t,r=r.map(ie.decode),new Er({initialPosition:t,position:e,plies:r,result:n})}constructor({initialPosition:t,position:e,result:r,plies:n}){Object.assign(this,{initialPosition:t,position:e,plies:n,result:r}),Object.freeze(this)}get index(){return this.plies.length}transit(t,e){const{initialPosition:r,position:n,plies:o}=this,{from:i,to:s}=t;return new Er({initialPosition:r,position:n.transit(n.ply(i,s)),plies:[...o,t],result:e})}undo(t){const{initialPosition:e,position:r}=this;return new Er({initialPosition:e,position:t.reduce(((t,e)=>t.undo(e)),r),plies:this.plies.slice(0,-t.length),result:void 0})}}const{EVENT:xr}=n;class Pr{#k;#A;#E;#x;#P;#$;#C;constructor(t,{delay:e=500,handle:r,...n}={}){this.#E=t,this.#x=e,this.#P=n,this.handle=r}set handle(t){this.#k!==t&&(this.#k&&(this.#A(),this.#k=void 0),t&&(this.#k=t,this.#A=t.subscribe(((...t)=>this.#O(...t)))))}get color(){return this.#k.color}get profile(){return{color:this.#k.color}}get options(){return this.#P}#O(t,e){switch(t){case xr.START:case xr.RESUME:this.#N(e);break;case xr.MOVE:this.#S(e);break;case xr.UNDO:this.#j(e)}}#N({index:t,game:e}){this.#$=Er.load(e),this.#C=t,this.#z()}#S({index:t,ply:e,result:r}){e=ie.decode(e),this.#$=this.#$.transit(e,r),this.#C=t+1,this.#z()}#j({index:t,plies:e}){this.#$=this.#$.undo(e),this.#C=t-e.length,this.#z()}#z(){const t=this.#C,e=this.#$;if(e.position.color!==this.color||e.result)return;const r=Date.now()+this.#x;setTimeout((()=>this.#M(t,e,r)))}async#M(t,e,r){const n=performance.now(),o=await this.#E.next(e),i=performance.now()-n;console.log(`[BOT] ${N(this.#k.color)}: ${o} (${i.toFixed(2)}ms)`);const s=r-Date.now();s>0?setTimeout((()=>this.#k.move(t,o)),s):this.#k.move(t,o)}}class $r{#v;constructor({rules:t}={}){this.#v=new wr({rules:t})}async next(t){const e=this.#v.queries(t.position).nextLegalPlies;return Ne(Ne(Object.values(e.reduce(((t,e)=>{const r=`${e.pid}`;return(t[r]=t[r]||[]).push(e),t}),{}))))}}class Cr{#T;constructor(t){Object.assign(this,t),Object.freeze(this)}get me(){return this.before.color}get opponent(){return S(this.me)}get after(){return this.#T||(this.#T=this.before.preview(this.ply))}}class Or{#v;#I;#L;constructor({config:t,heuristic:e}={}){const{rules:r}=t;this.#v=new wr({rules:r}),this.#I=t||{},this.#L=e||(()=>0)}async next({position:t,plies:e}){const r=this.#v,n=function(t){for(let e=t.length;e>1;){const r=Math.floor(Math.random()*e);e--,e!==r&&([t[e],t[r]]=[t[r],t[e]])}return t}(r.queries(t).nextLegalPlies),o=e.slice(-2);o.reverse();let i,s={context:r,lastPlies:o,before:t};s.t=function(t){const e=new Map;return{memoize(r,n){if(e.has(r))return e.get(r);const o=n(t);return e.set(r,o),o}}}(s);let c=!1;const a=[];for(const t of n){const e=this.#R(new Cr({...s,ply:t}));if(e===1/0){const{preferences:e}=this.#I;if(i)continue;if(i=t,Math.random()<(e.win||1)){c=!0;break}}a.push({score:e,ply:t})}if(i&&(c||0===a.length))return this.#K(s,1/0,{ply:i,score:1/0}),i;Wt(a,(t=>-t.score));const u=this.#U(a);return this.#K(s,i?1/0:a[0].score,u),u.ply}#R(t){return Math.round(this.#L.evaluate(t))}#U(t){for(const e of t){const{score:t}=e;if(Math.random()>.5**Math.max(1,t/100))return e}return t[t.length-1]}#K(t,e,r){const{ply:n}=r;console.log(t.before.fen,t.lastPlies.map((t=>t.code))),console.log(`${n}: ${Nr(r.score)} ${r.score===e?"(best)":`(best = ${Nr(e)})`} = ${this.#L.explain(new Cr({...t,ply:n}))}`)}}function Nr(t){return t===1/0?"win":`${t}`}class Sr{constructor(t,e={}){Object.assign(this,e),this._fn=t,Object.freeze(this)}evaluate(t){return this._fn(t)}explain(t){const{name:e}=this;return`${e?`${e}:`:""}${this.evaluate(t)}`}}function jr(t,e){return[r=>t.evaluate(r)*e,{explain:r=>`(${t.explain(r)})*${e}`}]}function zr(t,e){return r=>e.test(r)?t.evaluate(r):0}function Mr(t,e){return Wt(e,(t=>t.maxScore||0)),[r=>{const n=t.evaluate(r);for(const{predicate:t,maxScore:o}of e)if(t.test(r))return Math.min(o,n);return n},{explain:r=>{const n=t.evaluate(r);for(const{predicate:t,maxScore:o}of e)if(t.test(r)&&n>o)return`softbanned to ${o}`;return t.explain(r)}}]}function Tr(){return Ir}const Ir=new Sr((()=>0),{name:"zero",zero:!0,filter(){return this},scale(){return this}});function Lr(t,e,r={}){return new Sr(e,{name:t,...r})}const Rr=400;function Kr(){return Rr}const Ur=100,Br=200,qr=[200,200,400,900,450,999999];function Dr(t,e){const r=function(t){return 15&t}(e);if(!function(t){return t>=11&&t<=15}(r))return qr[r>>1];const n=t.board.pieces.get(e)>>4;return V(e)===n>4?Br:Ur}const _r="naive.";function Hr(t){return _r+t}const Vr="naive",Wr=.5,Fr=50;function Gr(t,e,r,n,o){const i=[];for(const{pid:e}of ae(t,r)){let r=o(t,e);n.has(e)||(r*=Wr),i.push({pid:e,score:r})}for(const{pid:t,score:r}of Wt(i,(t=>-t.score)))if(Xr(e,t))return r;return 0}function Qr(t,e){if(Xr(t,e))return!1;for(const{captured:r}of ze(t,e))if(!X(r)&&Xr(t,r))return!0;return!1}function Jr(t,e,r){if(X(r))return 0;let n=1/0;for(const o of Ie(e,r)){const i=e.preview(o);if(!Te(i,o.pid))return t(e,r);n=Math.min(n,t(i,o.pid))}if(n===1/0)return 0;const o=t(e,r);return Math.max(o-n,0)}function Xr(t,e){if(X(e))return!1;for(const r of Ie(t,e))if(!Te(t.preview(r),r.pid))return!0;return!1}const Yr=Lr("win",(({context:t,after:e,me:r})=>{const n=t.queries(e).result;return n&&n.type===g&&n.winner===r?1/0:0}));class Zr{constructor(t){this._fn=t}test(t){return this._fn(t)}get negate(){return new Zr((t=>!this.test(t)))}}function tn(t){return new Zr(t)}tn((()=>!0)),tn((()=>!1));const en=tn((({before:t,ply:e})=>{const r=t.color===f;r&&(e=e.mirror);const{pid:n,captured:o,from:i,to:s}=e;if(!tt(n)||!Z(o))return!1;const c=33===i;return!(!c&&39!==i||s!==(c?145:151))&&function(t){return t>>1==11}((r?t.board.mirror:t.board).at(c?144:152))}));const rn=tn((({before:t,ply:e})=>{if(t.moveNum>3)return!1;const r=t.color===f;r&&(e=e.mirror);const{pid:n,to:o}=e;return!!tt(n)&&(97===o||103===o||(34===o||36===o||38===o)&&function(t){return t>=27&&t<=31}((r?t.board.mirror:t.board).at(o+64)))}));!function(t){for(const[e,r]of Object.entries(i))t.prototype[e]=function(...e){return new t(...(n=r(this,...e),Array.isArray(n)?n:void 0===n?[]:[n]));var n}}(Sr);var nn=[{preset:"butterfly",abilities:{}},{preset:"bunny",abilities:{dodge:1}},{preset:"crab",abilities:{capture:1},quirks:{sidewalk:!0}},{preset:"duckling",abilities:{capture:1,dodge:1}},{preset:"chihuahua",preferences:{capture:.5,check:2,chase:2},abilities:{capture:1,check:1,chase:1}},{preset:"kitten",abilities:{capture:1,dodge:1,protect:1,check:1,chase:1,win:1},knowledge:{valuing:1}}];const on=nn.reduce(((t,e)=>(t[e.preset]=e,t)),{});function sn(t){return"random"===t&&(t=Ne(Object.values(nn))),"string"==typeof t&&(t={preset:t}),function(t={},{abilities:e,preferences:r,knowledge:n,quirks:o,...i}={}){return e={...t.abilities,...e},r={...t.preferences,...r},n={...t.knowledge,...n},o={...t.quirks,...o},{...t,abilities:e,preferences:r,knowledge:n,quirks:o,...i}}(on[t.preset],t)}function cn(t){const{abilities:{win:e,...r}={},preferences:n={},rules:o}=t=sn(t);let i=Object.keys(r);if(e>0&&(i=["win",...i]),0===i.length)return new Pr(new $r);const c=function({knowledge:t={}}={}){const{valuing:e=0}=t;return 0===e?"naive":"standard"}(t);let a=function(...t){t=t.filter((t=>!t.zero));const e=t.length;return 0===e?Tr():1===e?t[0]:(r=e=>{let r=0;for(const n of t){const t=n.evaluate(e);if(t===1/0)return t;r+=t}return r},n={explain:e=>t.map((t=>t.explain(e))).join(" + ")},new Sr(r,n));var r,n}(...i.map((t=>function(t,e,r){return function(t,e=1){return 1===e?t:0===e?Tr():t.scale(e)}(function(t,e){const r={valuing:e};switch(t){case"capture":return function({valuing:t=Vr}={}){const e=s[t];return Lr(Hr("capture"),(({before:t,ply:r,t:n})=>{const{captured:o}=r;if(!H(o))return 0;const i=n.memoize("capture.is-focused",(({lastPlies:t})=>{const e=t.length;return 0===e?()=>!1:1===e?({captured:e})=>e===t[0].pid:({captured:e,pid:r})=>e===t[0].pid||r===t[1].pid})),s=e(t,o);return i(r)?s:s*Wr}))}(r);case"dodge":return function({valuing:t=Vr}={}){const e=s[t];return Lr(Hr("dodge"),(({lastPlies:t,ply:r,before:n,after:o})=>{const{pid:i}=r,s=t[0]&&t[0].pid,c=Me(n,i,s)||Me(o,i,s);let a=Jr(e,n,i);return c||(a*=Wr),a-Jr(e,o,i)}))}(r);case"protect":return function({valuing:t=Vr}={}){const e=s[t];return Lr(Hr("protect"),(({ply:t,before:r,after:n,t:o})=>{const{pid:i,captured:s}=t,c=o.memoize("protect.focused-targets",(({lastPlies:t,before:e})=>0===t.length?new Set:new Set([...ze(e,t[0].pid)].map((t=>t.captured))))),a=Xr(n,i),u=!a&&H(s)?function(t,e,r){if(Xr(e,r))return 0;let n=[];for(const{captured:o}of ze(e,r)){if(X(o))continue;const r=t(e,o);n.push({captured:o,score:r})}for(const{captured:t,score:r}of Wt(n,(t=>-t.score)))if(Xr(e,t))return r;return 0}(e,r,s):0,l=a?0:Gr(n,r,i,c,e),h=Gr(r,n,i,c,e);return Math.max(u,l)-h}))}(r);case"check":return Lr(Hr("check"),(({ply:t,after:e})=>{const{pid:r}=t;for(const{captured:t}of ze(e,r))if(X(t))return Fr;return 0}));case"chase":return Lr(Hr("chase"),(({ply:t,before:e,after:r})=>{const{pid:n,captured:o}=t,i=Qr(r,n)?Fr:0;return!H(o)&&Qr(e,n)?i-Fr:i}));case"win":return Yr;default:throw new Error(`Unrecognized ability config: ${t}.`)}}(t,e),r)}(t,c,n[t]))));return a=function(t,{abilities:e}){const r=[];return e.chase>0&&r.push({predicate:rn,maxScore:0}),void 0===e.dodge&&e.capture>0&&r.push({predicate:en,maxScore:-100}),r.length>0&&(t=t.softbans(r)),t}(a,t),new Pr(new Or({config:t,heuristic:a}))}class an{#B;constructor(t,e){this.#B=e,this.color=t,Object.freeze(this)}subscribe(t){const e=({data:{name:e,event:r}})=>t(e,r);return this.#B.addEventListener("message",e),()=>this.#B.removeEventListener("message",e)}send(t,e){this.#B.postMessage({name:t,data:e})}}Object.assign(an.prototype,vr),async function(t){const{color:e,config:r}=await async function(t){return new Promise((e=>{const r=({data:n={}})=>{void 0!==n.color&&void 0!==n.config&&(t.removeEventListener("message",r),e(n))};t.addEventListener("message",r)}))}(t),n=new an(e,t);cn(sn(r)).handle=n}(self)}();